services:
  nominatim:
    image: mediagis/nominatim:5.1
    container_name: nominatim_planet
    mem_limit: 20g
    memswap_limit: 20g
    shm_size: 20g
    ports:
      - "8001:8080"
    volumes:
      - $PWD/data/nominatim/flatnode:/nominatim/flatnode
      - $PWD/data/nominatim/postgres:/var/lib/postgresql/16/main
      - $PWD/data/nominatim/data:/nominatim/data
    environment:
      - PBF_PATH=/nominatim/data/planet-latest.osm.pbf
      - IMPORT_WIKIDATA=true
    tty: true
    stdin_open: true

  overpass:
    image: wiktorn/overpass-api
    container_name: overpass
    mem_limit: 20g
    memswap_limit: 20g
    shm_size: 20g
    ports:
      - "8002:80"
    volumes:
      - $PWD/data/overpass/db_planet:/db
      - /everything/osm/planet/planet-250915.osm.pbf:/data/planet-latest.osm.pbf:ro
    environment:
      - OVERPASS_MODE=init
      - OVERPASS_META=yes
      - OVERPASS_PLANET_URL=file:///data/planet-latest.osm.pbf
      - OVERPASS_COMPRESSION=lz4
      - OVERPASS_RULES_LOAD=50

  valhalla:
    image: ghcr.io/nilsnolde/docker-valhalla/valhalla:latest
    container_name: valhalla_gis-ops
    ports:
      - "8003:8002"
    volumes:
      - $PWD/data/valhalla/custom_files:/custom_files
    environment:
      - CONFIG_FILE=/custom_files/valhalla.json
    entrypoint:
      - sh
      - -c
      - |
        echo "Waiting for file: /custom_files/planet-latest.osm.pbf..."
        while [ ! -f "/custom_files/planet-latest.osm.pbf" ]; do
          echo "Still waiting for file: /custom_files/planet-latest.osm.pbf"
          sleep 10
        done
        echo "Found file: /custom_files/planet-latest.osm.pbf."
        echo "Executing: /valhalla/scripts/run.sh build_tiles"
        exec /valhalla/scripts/run.sh build_tiles
    tty: true
    stdin_open: true
