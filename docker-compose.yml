version: '3.8'

services:
  tileserver:
    image: maptiler/tileserver-gl:latest
    container_name: tileserver
    ports:
      - "8000:8080"
    volumes:
      - ./data:/data
      - ./scripts/wait-for-path.sh:/usr/local/bin/wait-for-path.sh
    entrypoint: ["/usr/local/bin/wait-for-path.sh", "/data/*.mbtiles", "/run.sh"]
    tty: true
    stdin_open: true

  nominatim:
    image: mediagis/nominatim:5.1
    container_name: nominatim_planet
    mem_limit: 20g
    memswap_limit: 20g
    mem_swappiness: 10
    shm_size: 24g
    ports:
      - "8001:8080"
    volumes:
      - nominatim-flatnode:/nominatim/flatnode
      - nominatim-postgresql:/var/lib/postgresql/16/main
      - ./data:/nominatim/data
      - ./scripts/wait-for-path.sh:/usr/local/bin/wait-for-path.sh
    environment:
      - PBF_PATH=/nominatim/data/planet-latest.osm.pbf
      - IMPORT_STYLE=admin
    entrypoint: ["/usr/local/bin/wait-for-path.sh", "/nominatim/data/planet-latest.osm.pbf", "/usr/local/bin/entrypoint.sh"]
    tty: true
    stdin_open: true

  valhalla:
    image: ghcr.io/nilsnolde/docker-valhalla/valhalla:latest
    container_name: valhalla_gis-ops
    ports:
      - "8002:8002"
    volumes:
      - ./data:/custom_files
      - ./scripts/wait-for-path.sh:/usr/local/bin/wait-for-path.sh
    entrypoint: ["/usr/local/bin/wait-for-path.sh", "/custom_files/planet-latest.osm.pbf", "/app/entrypoint.sh"]
    tty: true
    stdin_open: true

  overpass:
    image: wiktorn/overpass-api
    container_name: overpass_monaco
    ports:
      - "8003:80"
    volumes:
      - ./data/overpass_db:/db
    environment:
      - OVERPASS_META=yes
      - OVERPASS_MODE=init
      - OVERPASS_PLANET_URL=http://download.geofabrik.de/europe/monaco-latest.osm.bz2
      - OVERPASS_DIFF_URL=http://download.openstreetmap.fr/replication/europe/monaco/minute/
      - OVERPASS_RULES_LOAD=10

volumes:
  nominatim-flatnode:
    driver: local
  nominatim-postgresql:
    driver: local
