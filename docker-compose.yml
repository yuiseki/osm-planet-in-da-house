version: '3.8'

services:
  tileserver:
    image: maptiler/tileserver-gl:latest
    container_name: tileserver
    ports:
      - "8000:8080"
    volumes:
      - ./data:/data
    tty: true
    stdin_open: true

  nominatim:
    image: mediagis/nominatim:5.1
    container_name: nominatim_planet
    mem_limit: 20g
    memswap_limit: 20g
    mem_swappiness: 10
    shm_size: 24g
    ports:
      - "8001:8080"
    volumes:
      - nominatim-flatnode:/nominatim/flatnode
      - nominatim-postgresql:/var/lib/postgresql/16/main
      - ./data:/nominatim/data
    environment:
      - PBF_PATH=/nominatim/data/planet-latest.osm.pbf
      - IMPORT_STYLE=admin
    tty: true
    stdin_open: true

  valhalla:
    image: ghcr.io/nilsnolde/docker-valhalla/valhalla:latest
    container_name: valhalla_gis-ops
    ports:
      - "8002:8002"
    volumes:
      - ./data:/custom_files
    tty: true
    stdin_open: true

  overpass:
    image: wiktorn/overpass-api
    container_name: overpass_monaco
    ports:
      # The original script used port 8002, which conflicts with valhalla.
      # Changed to 8003 based on the script name 8003_overpass.sh.
      - "8003:80"
    volumes:
      - ./data/overpass_db:/db
    environment:
      - OVERPASS_META=yes
      - OVERPASS_MODE=init
      - OVERPASS_PLANET_URL=http://download.geofabrik.de/europe/monaco-latest.osm.bz2
      - OVERPASS_DIFF_URL=http://download.openstreetmap.fr/replication/europe/monaco/minute/
      - OVERPASS_RULES_LOAD=10

volumes:
  nominatim-flatnode:
    driver: local
  nominatim-postgresql:
    driver: local
